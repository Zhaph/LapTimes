@{
    ViewBag.Title = "Let's Race!";
}
@section featured {
    <section class="featured">
        <div class="content-wrapper">
          <hgroup class="title">
              <h1>@ViewBag.Title</h1>
              <h2 data-bind="visible: !CurrentRace()">@ViewBag.Message</h2>
              <h2 data-bind="visible: CurrentRace()">The race has started!</h2>
          </hgroup>
          <div id="raceDetails" data-bind="visible: CurrentRace() ? CurrentRace().IsInProgress : false">
            <ul style="list-style: none; padding: 0 0 5px;">
              <li>
                <i class="fa fa-tachometer"></i> In lane <span t-data-bind="text: Lane"></span>, we have <span t-data-bind="text: Name"></span> driving <span t-data-bind="text: Car"></span>
              </li>
            </ul>
          </div>
        </div>
    </section>
}
<h3 style="text-align: center;"><i class="fa fa-flag-checkered fa-lg"></i> Current Leaders <i class="fa fa-flag-checkered fa-lg"></i></h3>

<div data-bind="foreach:Leagues" class="clear-fix">
  <div data-bind="style: { width: $root.getWidth()}" style="text-align: center;" class="float-left">
    <h4 data-bind="text: Name"></h4>
    <ul data-bind="foreach: Racers" style="list-style: none; padding: 0;">
      <li>
        <h5>
          <!-- ko if: $index() === 0 -->
          <i class="fa fa-trophy fa-2x gold"></i>
          <!-- /ko -->
          <!-- ko if: $index() === 1 -->
          <i class="fa fa-trophy fa-lg silver"></i>
          <!-- /ko -->
          <!-- ko if: $index() === 2 -->
          <i class="fa fa-trophy bronze"></i>
          <!-- /ko -->
          <span data-bind="text: Name"></span>
        </h5>
        <p data-bind="text: BestTime()"></p>
      </li>
    </ul>
  </div>
</div>

@section scripts {
  <!--Reference the SignalR library. -->
  <script src="~/Scripts/jquery.signalR-1.1.3.js"></script>
  <script src="~/Scripts/knockout-2.1.0.js"></script>
  <!--Reference the autogenerated SignalR hub script. -->
  <script src="~/signalr/hubs"></script>

  <script>

    function convertTime(time) {
      function addZ(n) {
        return (n < 10 ? '0' : '') + n;
      }

      function addZZ(n) {
        return (n < 100 ? '0' + addZ(n) : n);
      }

      var ms = time % 1000;
      time = (time - ms) / 1000;
      var secs = time % 60;
      time = (time - secs) / 60;
      var mins = time % 60;

      return addZ(mins) + ':' + addZ(secs) + '.' + addZZ(ms);
    }

    $(function () {

      function CurrentRacer(data) {
        var self = this;
        self.RacerId = data.RacerId;
        self.Name = ko.observable(data.Name);
        self.Car = ko.observable(data.Car.Name);
        self.Lane = ko.observable(data.Lane);
        self.RawRaceTime = ko.observable(data.RawRaceTime);
        self.RawBestTime = ko.observable(data.RawBestTime);

        self.RaceTime = function () {
          var time = self.RawRaceTime();

          return convertTime(time);
        };
      }

      function Racer(data) {
        var self = this;
        self.RacerId = data.RacerId;
        self.Name = ko.observable(data.Name);
        self.RawBestTime = ko.observable(data.RawBestTime);

        self.BestTime = function () {
          var time = self.RawBestTime();

          return convertTime(time);
        };
      }

      function League(data) {
        var self = this;
        self.LeagueId = data.LeagueId;
        self.Name = ko.observable(data.Name);

        var mappedDrivers = $.map(data.Drivers, function (item) {
          return new Racer(item);
        });
        self.Racers = ko.observableArray(mappedDrivers);
      }

      function CurrentRace(data) {
        if (!data) {
          return;
        }

        var self = this;
        self.RaceId = data.RaceId;
        self.IsComplete = ko.observable(data.IsComplete);
        self.StartTime = ko.observable(data.StartTime);
        self.EndTime = ko.observable(data.EndTime);

        var mappedRacers = $map(data.Racers, function (item) {
          return new CurrentRacer(item);
        });
        self.Racers = ko.observableArray(mappedRacers);

        self.IsInProgress = function () {
          return !self.IsComplete;
        };
      }

      function LeaguesViewModel() {
        var self = this;
        self.Leagues = ko.observableArray([]);
        self.CurrentRace = ko.observable();

        var race = $.connection.raceHub;

        //Initializes the view model
        self.init = function () {
          race.server.getAllLeagues();
        };

        race.client.getAllLeagues = function (currentLeaderBoards, currentRace) {
          var mappedLeagues = $.map(currentLeaderBoards, function (item) {
            return new League(item);
          });

          self.Leagues(mappedLeagues);
          self.CurrentRace = new CurrentRace(currentRace);
        };

        race.client.updateRace = function (currentRace) {
          var raceStatus = $('#raceStatus');
          if (!currentRace.IsComplete) {
            raceStatus.html("Race in progress!");
          }
          else {
            raceStatus.html("Race complete!");
          }
        };

        self.getWidth = function () {
          return 100 / self.Leagues().length + '%';
        };
      };

      var vm = new LeaguesViewModel();
      // Start the connection
      $.connection.hub.start(function () { vm.init(); });

      ko.applyBindings(vm);
    });
  </script>
}