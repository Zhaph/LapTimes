@{
    ViewBag.Title = "Let's Race!";
}
@section featured {
    <section class="featured">
        <div class="content-wrapper">
            <hgroup class="title">
                <h1>@ViewBag.Title</h1>
                <h2 id="raceStatus">@ViewBag.Message</h2>
            </hgroup>
            <p id="raceDetails">
                To learn more about ASP.NET MVC visit
                <a href="http://asp.net/mvc" title="ASP.NET MVC Website">http://asp.net/mvc</a>.
                The page features <mark>videos, tutorials, and samples</mark> to help you get the most from ASP.NET MVC.
                If you have any questions about ASP.NET MVC visit
                <a href="http://forums.asp.net/1146.aspx/1?MVC" title="ASP.NET MVC Forum">our forums</a>.
            </p>
        </div>
    </section>
}
<h3><i class="fa fa-flag-checkered fa-lg"></i> Current Leaders <i class="fa fa-flag-checkered fa-lg"></i></h3>

<div data-bind="foreach:Leagues" class="clear-fix">
  <div style="width: 30%; text-align: center;" class="float-left">
    <h4 data-bind="text: Name"></h4>
    <ul data-bind="foreach: Racers" style="list-style: none;">
      <li>
        <h5>
          <!-- ko if: $index() === 0 -->
          <i class="fa fa-trophy fa-2x gold"></i>
          <!-- /ko -->
          <!-- ko if: $index() === 1 -->
          <i class="fa fa-trophy fa-lg silver"></i>
          <!-- /ko -->
          <!-- ko if: $index() === 2 -->
          <i class="fa fa-trophy bronze"></i>
          <!-- /ko -->
          <span data-bind="text: Name"></span>
        </h5>
        <p data-bind="text: RawBestTime"></p>
      </li>
    </ul>
  </div>
</div>
<ol class="round">
  <li class="one">
    <h5><i class="fa fa-trophy fa-2x gold"></i> Current First Place</h5>
    <p>00:45:00</p>
  </li>
  <li class="two">
      <h5><i class="fa fa-trophy fa-lg silver"></i> Current Second Place</h5>
    <p>00:50:00</p>
  </li>
  <li class="three">
    <h5><i class="fa fa-trophy bronze"></i> Current Third Place</h5>
    <p>00:55:00</p>
  </li>
  <li class="four">
    <h5>Fourth place</h5>
    <p>01:00:00</p>
  </li>
  <li class="five">
    <h5> <i class="fa fa-tachometer"></i></h5>
    <p>01:05:00</p>
  </li>
</ol>

@section scripts {
  <!--Reference the SignalR library. -->
  <script src="~/Scripts/jquery.signalR-1.1.3.js"></script>
  <script src="~/Scripts/knockout-2.1.0.js"></script>
  <!--Reference the autogenerated SignalR hub script. -->
  <script src="~/signalr/hubs"></script>

  <script>
    $(function () {

      function Racer(data) {
        var self = this;
        self.RacerId = data.RacerId;
        self.Name = ko.observable(data.Name);
        self.RawBestTime = ko.observable(data.RawBestTime);

        self.BestTime = ko.computed(function() {
          var time = self.RawBestTime();
         
          function addZ(n) {
            return (n < 10 ? '0' : '') + n;
          }

          var ms = time % 1000;
          time = (time - ms) / 1000;
          var secs = time % 60;
          time = (time - secs) / 60;
          var mins = time % 60;

          return addZ(mins) + ':' + addZ(secs) + '.' + ms;
        });
      }

      function League(data) {
        var self = this;
        self.LeagueId = data.LeagueId;
        self.Name = ko.observable(data.Name);

        var mappedDrivers = $.map(data.Drivers, function (item) {
          return new Racer(item);
        });

        self.Racers = ko.observableArray(data.Drivers);
      }

      function LeaguesViewModel() {
        var self = this;
        self.Leagues = ko.observableArray([]);

        var race = $.connection.raceHub;

        //Initializes the view model
        this.init = function () {
          race.server.getAllLeagues();
        }

        race.client.getAllLeagues = function (currentLeaderBoards) {
          var mappedLeagues = $.map(currentLeaderBoards, function (item) {
            return new League(item);
          });

          self.Leagues(mappedLeagues);
        }

        race.client.updateRace = function (currentRace) {
          var raceStatus = $('#raceStatus');
          if (!currentRace.IsComplete) {
            raceStatus.html("Race in progress!");
          }
          else {
            raceStatus.html("Race complete!");
          }
        };
      };

      var vm = new LeaguesViewModel();
      // Start the connection
      $.connection.hub.start(function () { vm.init(); });

      ko.applyBindings(vm);
    });
  </script>
}